language: generic
git:
  depth: false
  submodules: false
script:
# Make sure our iso command works
- ./iso dmd-build
#- ./iso dmd-build bash -c "exit"
# install build library
- git clone --depth=1 --branch=master https://github.com/marler8997/buildlib.git ../buildlib
# install rund
- git clone --depth=1 --branch=master https://github.com/marler8997/rund.git ../rund
- ./iso dmd-build dmd -I../rund/src -run ../rund/make.d build
# TODO: create a nix expression for rund, install rund via nix
# build dmd using ldc
- GEN_DIR=generated/ldc-build ./iso ldc-build ../rund/bin/rund src/build.d
# build dmd using dmd
- ./iso dmd-build ../rund/bin/rund src/build.d
# build druntime and phobos.
- git clone --depth=1 --branch=master https://github.com/dlang/druntime.git ../druntime
- git clone --depth=1 --branch=master https://github.com/dlang/phobos.git ../phobos
- ./iso dmd-build make -j$(nproc) -C ../druntime -f posix.mak DMD=../dc/generated/linux/release/64/dmd DMD_DIR=../dc CC=$(which gcc)
- ./iso dmd-build make -j$(nproc) -C ../phobos -f posix.mak DMD=../dc/generated/linux/release/64/dmd DMD_DIR=../dc CC=$(which gcc)
# run unittest and testsuite.
#make -j$(nproc) -C ../druntime -f posix.mak DMD=../dc/generated/linux/release/64/dmd unittest
#make -j$(nproc) -C ../phobos -f posix.mak DMD=../dc/generated/linux/release/64/dmd unittest
#make -j$(nproc) -C test DMD=../dc/generated/linux/release/64/dmd MODEL=64
# run the dmd test suite
- ./iso dmd-test dmd -g -debug -run test/run.d
